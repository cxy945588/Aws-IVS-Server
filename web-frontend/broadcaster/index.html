<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AWS IVS å¤š Stage ç›´æ’­ - ä¸»æ’­ç«¯</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      width: 100%;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 16px;
    }

    .content {
      padding: 30px;
    }

    .section {
      margin-bottom: 30px;
    }

    .section h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .config-section {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
    }

    .input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .input-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .video-preview {
      width: 100%;
      max-width: 800px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .video-preview video {
      width: 100%;
      display: block;
    }

    .button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-right: 10px;
    }

    .button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    .button:active:not(:disabled) {
      transform: translateY(0);
    }

    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .button.danger {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .status-box {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .status-item:last-child {
      border-bottom: none;
    }

    .status-label {
      color: #666;
      font-weight: 500;
    }

    .status-value {
      color: #333;
      font-weight: 600;
    }

    .status-value.active {
      color: #4caf50;
    }

    .status-value.inactive {
      color: #f44336;
    }

    .stages-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stage-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      transition: border-color 0.3s;
    }

    .stage-card.connected {
      border-color: #4caf50;
    }

    .stage-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .stage-id {
      font-weight: 600;
      color: #333;
    }

    .stage-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .stage-status.connected {
      background: #4caf50;
      color: white;
    }

    .stage-status.disconnected {
      background: #999;
      color: white;
    }

    .stage-info {
      font-size: 14px;
      color: #666;
    }

    .logs {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 8px;
      height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.5;
    }

    .logs::-webkit-scrollbar {
      width: 8px;
    }

    .logs::-webkit-scrollbar-track {
      background: #2e2e2e;
    }

    .logs::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 4px;
    }

    .log-entry {
      margin-bottom: 4px;
    }

    .log-time {
      color: #888;
    }

    .log-error {
      color: #ff5555;
    }

    .log-success {
      color: #50fa7b;
    }

    .log-info {
      color: #8be9fd;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>AWS IVS å¤š Stage ç›´æ’­ - ä¸»æ’­ç«¯</h1>
      <p>ä½¿ç”¨ AWS IVS Web Broadcast SDK åŒæ™‚æ¨æµåˆ°å¤šå€‹ Stage</p>
    </div>

    <div class="content">
      <!-- é…ç½®å€ -->
      <div class="section">
        <h2>ğŸ”§ é…ç½®</h2>
        <div class="config-section">
          <div class="input-group">
            <label for="apiServer">API Server URL</label>
            <input type="text" id="apiServer" value="http://localhost:3000" placeholder="http://localhost:3000">
          </div>
          <div class="input-group">
            <label for="apiKey">API Key</label>
            <input type="password" id="apiKey" placeholder="è¼¸å…¥ä½ çš„ API Key">
          </div>
        </div>
      </div>

      <!-- è¦–é »é è¦½ -->
      <div class="section">
        <h2>ğŸ“¹ æœ¬åœ°è¦–é »é è¦½</h2>
        <div class="video-preview">
          <video id="localVideo" autoplay muted playsinline></video>
        </div>
        <button class="button" id="startBtn" onclick="startBroadcast()">é–‹å§‹ç›´æ’­</button>
        <button class="button danger" id="stopBtn" onclick="stopBroadcast()" disabled>åœæ­¢ç›´æ’­</button>
      </div>

      <!-- ç‹€æ…‹ç›£æ§ -->
      <div class="section">
        <h2>ğŸ“Š ç‹€æ…‹ç›£æ§</h2>
        <div class="status-box">
          <div class="status-item">
            <span class="status-label">æœ¬åœ°åª’é«”æµ</span>
            <span class="status-value inactive" id="statusMedia">æœªå°±ç·’</span>
          </div>
          <div class="status-item">
            <span class="status-label">WebSocket é€£æ¥</span>
            <span class="status-value inactive" id="statusWS">æœªé€£æ¥</span>
          </div>
          <div class="status-item">
            <span class="status-label">å·²é€£æ¥ Stage æ•¸é‡</span>
            <span class="status-value" id="statusStageCount">0</span>
          </div>
          <div class="status-item">
            <span class="status-label">ç›´æ’­ç‹€æ…‹</span>
            <span class="status-value inactive" id="statusLive">é›¢ç·š</span>
          </div>
        </div>
      </div>

      <!-- Stage åˆ—è¡¨ -->
      <div class="section">
        <h2>ğŸ¬ é€£æ¥çš„ Stage</h2>
        <div class="stages-grid" id="stagesGrid">
          <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">
            å°šæœªé€£æ¥ä»»ä½• Stage
          </div>
        </div>
      </div>

      <!-- æ—¥èªŒ -->
      <div class="section">
        <h2>ğŸ“ æ—¥èªŒ</h2>
        <div class="logs" id="logs"></div>
      </div>
    </div>
  </div>

  <!-- AWS IVS Web Broadcast SDK -->
  <script src="https://web-broadcast.live-video.net/1.6.0/amazon-ivs-web-broadcast.js"></script>

  <script>
    // å…¨å±€ç‹€æ…‹
    const state = {
      localStream: null,
      stageClients: new Map(), // stageArn -> client
      ws: null,
      isLive: false,
    };

    // æ—¥èªŒå‡½æ•¸
    function log(message, type = 'info') {
      const logsDiv = document.getElementById('logs');
      const time = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      logEntry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
      logsDiv.appendChild(logEntry);
      logsDiv.scrollTop = logsDiv.scrollHeight;
      console.log(`[${type}] ${message}`);
    }

    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    function updateStatus(id, text, isActive = false) {
      const el = document.getElementById(id);
      el.textContent = text;
      el.className = `status-value ${isActive ? 'active' : 'inactive'}`;
    }

    // æ›´æ–° Stage é¡¯ç¤º
    function updateStagesDisplay() {
      const grid = document.getElementById('stagesGrid');
      grid.innerHTML = '';

      if (state.stageClients.size === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">å°šæœªé€£æ¥ä»»ä½• Stage</div>';
        return;
      }

      state.stageClients.forEach((client, stageArn) => {
        const card = document.createElement('div');
        card.className = `stage-card ${client.connected ? 'connected' : ''}`;
        card.innerHTML = `
          <div class="stage-card-header">
            <div class="stage-id">Stage: ${stageArn.split('/').pop()}</div>
            <div class="stage-status ${client.connected ? 'connected' : 'disconnected'}">
              ${client.connected ? 'å·²é€£æ¥' : 'æœªé€£æ¥'}
            </div>
          </div>
          <div class="stage-info">è§€çœ¾æ•¸: ${client.viewerCount || 0}</div>
        `;
        grid.appendChild(card);
      });

      updateStatus('statusStageCount', state.stageClients.size);
    }

    // åˆå§‹åŒ–æœ¬åœ°åª’é«”æµ
    async function initializeLocalStream() {
      try {
        log('æ­£åœ¨ç²å–æœ¬åœ°åª’é«”è¨­å‚™...', 'info');

        state.localStream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            frameRate: { ideal: 30 }
          },
          audio: true
        });

        document.getElementById('localVideo').srcObject = state.localStream;
        updateStatus('statusMedia', 'å·²å°±ç·’', true);
        log('æœ¬åœ°åª’é«”æµå·²å°±ç·’', 'success');

        return true;
      } catch (error) {
        log(`ç²å–æœ¬åœ°åª’é«”å¤±æ•—: ${error.message}`, 'error');
        alert('ç„¡æ³•è¨ªå•æ”åƒé ­æˆ–éº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­ç½®');
        return false;
      }
    }

    // é€£æ¥åˆ°å–®å€‹ Stage
    async function connectToStage(stageArn, token, viewerCount = 0) {
      try {
        const stageId = stageArn.split('/').pop();
        log(`æ­£åœ¨é€£æ¥åˆ° Stage: ${stageId}...`, 'info');

        // å‰µå»º Stage ç­–ç•¥é…ç½®
        const { Stage, LocalStageStream, StageEvents, StreamType } = IVSBroadcastClient;

        // å‰µå»º Stage å®¢æˆ¶ç«¯
        const strategy = {
          stageStreamsToPublish() {
            return [
              new LocalStageStream(0, state.localStream.getVideoTracks()[0]),
              new LocalStageStream(1, state.localStream.getAudioTracks()[0])
            ];
          },
          shouldPublishParticipant() {
            return true;
          },
          shouldSubscribeToParticipant() {
            return false; // ä¸»æ’­ä¸éœ€è¦è¨‚é–±å…¶ä»–åƒèˆ‡è€…
          }
        };

        const stage = new Stage(token, strategy);

        // ç›£è½äº‹ä»¶
        stage.on(StageEvents.STAGE_CONNECTION_STATE_CHANGED, (state) => {
          log(`Stage ${stageId} é€£æ¥ç‹€æ…‹: ${state}`, 'info');
          if (state === 'CONNECTED') {
            const client = state.stageClients.get(stageArn);
            if (client) {
              client.connected = true;
              updateStagesDisplay();
            }
          }
        });

        stage.on(StageEvents.STAGE_STREAM_ADDED, () => {
          log(`Stage ${stageId} é–‹å§‹æ¨æµ`, 'success');
        });

        stage.on(StageEvents.STAGE_PARTICIPANT_JOINED, (participant) => {
          log(`è§€çœ¾åŠ å…¥ Stage ${stageId}`, 'info');
        });

        // åŠ å…¥ Stage
        await stage.join();

        // ä¿å­˜å®¢æˆ¶ç«¯
        state.stageClients.set(stageArn, {
          stage,
          connected: true,
          viewerCount,
          stageArn,
        });

        log(`å·²é€£æ¥åˆ° Stage: ${stageId}`, 'success');
        updateStagesDisplay();
      } catch (error) {
        log(`é€£æ¥åˆ° Stage å¤±æ•—: ${error.message}`, 'error');
        console.error('Stage é€£æ¥éŒ¯èª¤:', error);
      }
    }

    // æ–·é–‹ Stage
    async function disconnectFromStage(stageArn) {
      try {
        const client = state.stageClients.get(stageArn);
        if (!client) return;

        const stageId = stageArn.split('/').pop();
        log(`æ­£åœ¨æ–·é–‹ Stage: ${stageId}...`, 'info');

        await client.stage.leave();
        state.stageClients.delete(stageArn);

        log(`å·²æ–·é–‹ Stage: ${stageId}`, 'success');
        updateStagesDisplay();
      } catch (error) {
        log(`æ–·é–‹ Stage å¤±æ•—: ${error.message}`, 'error');
      }
    }

    // é€£æ¥ WebSocket
    function connectWebSocket() {
      const apiServer = document.getElementById('apiServer').value;
      const apiKey = document.getElementById('apiKey').value;
      const wsUrl = apiServer.replace('http', 'ws') + `/ws?type=broadcaster&apiKey=${apiKey}`;

      log('æ­£åœ¨é€£æ¥ WebSocket...', 'info');

      state.ws = new WebSocket(wsUrl);

      state.ws.onopen = () => {
        log('WebSocket å·²é€£æ¥', 'success');
        updateStatus('statusWS', 'å·²é€£æ¥', true);
      };

      state.ws.onmessage = async (event) => {
        try {
          const message = JSON.parse(event.data);

          if (message.type === 'stage_created') {
            const { stageArn } = message.data;
            const stageId = stageArn.split('/').pop();
            log(`æ”¶åˆ°é€šçŸ¥: æ–° Stage å·²å‰µå»º (${stageId})`, 'info');

            // ç²å– Token ä¸¦é€£æ¥
            const token = await fetchStageToken(stageArn);
            if (token) {
              await connectToStage(stageArn, token);
            }
          } else if (message.type === 'stage_deleted') {
            const { stageArn } = message.data;
            const stageId = stageArn.split('/').pop();
            log(`æ”¶åˆ°é€šçŸ¥: Stage å·²åˆªé™¤ (${stageId})`, 'info');
            await disconnectFromStage(stageArn);
          }
        } catch (error) {
          log(`è™•ç† WebSocket æ¶ˆæ¯å¤±æ•—: ${error.message}`, 'error');
        }
      };

      state.ws.onerror = (error) => {
        log('WebSocket éŒ¯èª¤', 'error');
        updateStatus('statusWS', 'éŒ¯èª¤', false);
      };

      state.ws.onclose = () => {
        log('WebSocket å·²æ–·é–‹ï¼Œ3ç§’å¾Œé‡é€£...', 'error');
        updateStatus('statusWS', 'å·²æ–·é–‹', false);
        setTimeout(() => {
          if (state.isLive) {
            connectWebSocket();
          }
        }, 3000);
      };
    }

    // ç²å–æ‰€æœ‰æ´»èº Stage
    async function fetchActiveStages() {
      const apiServer = document.getElementById('apiServer').value;
      const apiKey = document.getElementById('apiKey').value;

      try {
        const response = await fetch(`${apiServer}/api/broadcaster/stages`, {
          headers: { 'x-api-key': apiKey }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        return data.stages;
      } catch (error) {
        log(`ç²å– Stage åˆ—è¡¨å¤±æ•—: ${error.message}`, 'error');
        return [];
      }
    }

    // ç²å–å–®å€‹ Stage Token
    async function fetchStageToken(stageArn) {
      const apiServer = document.getElementById('apiServer').value;
      const apiKey = document.getElementById('apiKey').value;

      try {
        const response = await fetch(`${apiServer}/api/broadcaster/stage-token`, {
          method: 'POST',
          headers: {
            'x-api-key': apiKey,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ stageArn })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        return data.token;
      } catch (error) {
        log(`ç²å– Stage Token å¤±æ•—: ${error.message}`, 'error');
        return null;
      }
    }

    // é–‹å§‹ç›´æ’­
    async function startBroadcast() {
      try {
        // é©—è­‰é…ç½®
        if (!document.getElementById('apiKey').value) {
          alert('è«‹è¼¸å…¥ API Key');
          return;
        }

        document.getElementById('startBtn').disabled = true;
        log('é–‹å§‹ç›´æ’­æµç¨‹...', 'info');

        // 1. åˆå§‹åŒ–æœ¬åœ°åª’é«”æµ
        const mediaReady = await initializeLocalStream();
        if (!mediaReady) {
          document.getElementById('startBtn').disabled = false;
          return;
        }

        // 2. ç²å–æ‰€æœ‰æ´»èº Stage
        log('æ­£åœ¨ç²å–æ´»èº Stage åˆ—è¡¨...', 'info');
        const stages = await fetchActiveStages();
        log(`ç²å–åˆ° ${stages.length} å€‹æ´»èº Stage`, 'success');

        // 3. é€£æ¥åˆ°æ‰€æœ‰ Stage
        for (const stage of stages) {
          await connectToStage(stage.stageArn, stage.token, stage.viewerCount);
        }

        // 4. å•Ÿå‹• WebSocket ç›£è½
        connectWebSocket();

        state.isLive = true;
        updateStatus('statusLive', 'ç›´æ’­ä¸­', true);
        document.getElementById('stopBtn').disabled = false;
        log('ç›´æ’­å·²é–‹å§‹ï¼', 'success');
      } catch (error) {
        log(`é–‹å§‹ç›´æ’­å¤±æ•—: ${error.message}`, 'error');
        document.getElementById('startBtn').disabled = false;
      }
    }

    // åœæ­¢ç›´æ’­
    async function stopBroadcast() {
      try {
        log('æ­£åœ¨åœæ­¢ç›´æ’­...', 'info');
        document.getElementById('stopBtn').disabled = true;

        // 1. æ–·é–‹æ‰€æœ‰ Stage
        const promises = Array.from(state.stageClients.keys()).map(arn =>
          disconnectFromStage(arn)
        );
        await Promise.all(promises);

        // 2. é—œé–‰ WebSocket
        if (state.ws) {
          state.ws.close();
          state.ws = null;
        }
        updateStatus('statusWS', 'æœªé€£æ¥', false);

        // 3. åœæ­¢æœ¬åœ°åª’é«”æµ
        if (state.localStream) {
          state.localStream.getTracks().forEach(track => track.stop());
          state.localStream = null;
          document.getElementById('localVideo').srcObject = null;
        }
        updateStatus('statusMedia', 'æœªå°±ç·’', false);

        state.isLive = false;
        updateStatus('statusLive', 'é›¢ç·š', false);
        document.getElementById('startBtn').disabled = false;
        log('ç›´æ’­å·²åœæ­¢', 'success');
      } catch (error) {
        log(`åœæ­¢ç›´æ’­å¤±æ•—: ${error.message}`, 'error');
        document.getElementById('stopBtn').disabled = false;
      }
    }

    // é é¢åŠ è¼‰æ™‚çš„æ—¥èªŒ
    log('ä¸»æ’­ç«¯é é¢å·²åŠ è¼‰', 'success');
    log('è«‹é…ç½® API Server å’Œ API Keyï¼Œç„¶å¾Œé»æ“Šã€Œé–‹å§‹ç›´æ’­ã€', 'info');
  </script>
</body>
</html>
