# API 設計修正報告

**日期**: 2025-10-21
**修正範圍**: 全面優化 API 設計，統一回應格式和錯誤處理

---

## 📋 修正概要

本次修正針對 AWS IVS Server API 的設計不一致問題進行全面優化，確保所有 API 端點遵循統一的標準。

### 主要改進

1. ✅ **統一回應格式** - 所有成功回應包含 `success`, `data`, `timestamp`
2. ✅ **統一錯誤處理** - 標準化錯誤回應結構
3. ✅ **統一欄位命名** - 確保所有 API 使用一致的欄位名稱
4. ✅ **改進驗證邏輯** - 詳細的缺失欄位提示
5. ✅ **創建 Helper 函數** - 統一的回應工具函數

---

## 🔧 修正詳情

### 1. 新增 Response Helper 工具 (`utils/responseHelper.ts`)

創建了統一的回應處理工具，包含以下函數：

```typescript
// 成功回應
sendSuccess(res, data, statusCode?, message?)

// 錯誤回應
sendError(res, errorCode, message, statusCode?, details?)
sendValidationError(res, message, missingFields?)
sendUnauthorized(res, message?)
sendForbidden(res, message?)
sendNotFound(res, resource?)
sendInternalError(res, error, customMessage?)
```

#### 標準回應格式

**成功回應**:
```json
{
  "success": true,
  "data": { ... },
  "timestamp": "2025-10-21T10:30:00.000Z",
  "message": "optional message"
}
```

**錯誤回應**:
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "錯誤說明",
    "details": "僅開發環境顯示"
  },
  "timestamp": "2025-10-21T10:30:00.000Z"
}
```

---

### 2. 修正的路由文件

#### 📁 `routes/stats.ts` - 統計資料路由

**修正內容**:
- ✅ 所有回應使用 `sendSuccess()`
- ✅ 所有錯誤使用 `sendInternalError()`
- ✅ 驗證錯誤使用 `sendError()` 並提供詳細提示
- ✅ 欄位命名統一：`stageArn`, `viewerCount`, `stageInfo`

**主要變更**:
```typescript
// 之前
res.status(200).json({
  success: true,
  data: { ... },
  timestamp: new Date().toISOString()
});

// 之後
sendSuccess(res, { ... });
```

---

#### 📁 `routes/stage.ts` - Stage 管理路由

**修正內容**:
- ✅ 使用完整的 helper 函數集
- ✅ `sendValidationError()` 提供缺失欄位列表
- ✅ `sendNotFound()` 替代手動構建 404 回應
- ✅ `sendForbidden()` 處理禁止操作
- ✅ 統一欄位命名：`isMasterStage` (布林值)

**主要變更**:
```typescript
// 驗證錯誤 - 之前
if (!name) {
  return res.status(400).json({
    error: 'VALIDATION_ERROR',
    message: '缺少 name 參數',
  });
}

// 驗證錯誤 - 之後
if (!name) {
  return sendValidationError(res, '缺少 name 參數', ['name']);
}
```

---

#### 📁 `routes/token.ts` - Token 生成路由

**修正內容**:
- ✅ 主播 Token 回應包含完整的 OBS 配置指南
- ✅ 觀眾 Token 自動分配邏輯保持不變
- ✅ Media Server Token 增強驗證
- ✅ 所有錯誤回應標準化

**主要變更**:
```typescript
// 主播 Token 回應 - 保留 instructions 但統一格式
sendSuccess(res, {
  token: token.token,
  participantId: token.participantId,
  userId: token.userId,
  stageArn: token.stageArn,
  capabilities: token.capabilities,
  expiresAt: token.expiresAt,
  whipEndpoint: API_ENDPOINTS.WHIP,
  expiresIn: Math.floor((token.expiresAt.getTime() - Date.now()) / 1000),
  instructions: {
    obs: { ... },
    web: { ... }
  }
});
```

---

#### 📁 `routes/viewer.ts` - 觀眾管理路由

**修正內容**:
- ✅ 所有 POST 端點使用標準回應
- ✅ 驗證錯誤提供詳細的缺失欄位
- ✅ 欄位命名統一：`heartbeatUpdated`, `viewerLeft`, `watchDurationSeconds`
- ✅ 成功訊息通過 `message` 參數傳遞

**主要變更**:
```typescript
// 心跳更新 - 之前
res.status(200).json({
  success: true,
  message: '心跳更新成功',
  timestamp: new Date().toISOString(),
});

// 心跳更新 - 之後
sendSuccess(res, {
  userId,
  stageArn,
  heartbeatUpdated: true,
}, HTTP_STATUS.OK, '心跳更新成功');
```

---

#### 📁 `routes/health.ts` - 健康檢查路由

**修正內容**:
- ✅ 使用 `sendSuccess()` 回應
- ✅ 錯誤回應使用標準格式
- ✅ 狀態欄位改為 `status: 'healthy'`

**主要變更**:
```typescript
// 之前
res.json({
  status: 'ok',
  timestamp: new Date().toISOString(),
  ...
});

// 之後
sendSuccess(res, {
  status: 'healthy',
  uptime: process.uptime(),
  environment: process.env.NODE_ENV,
  ...
});
```

---

## 📊 欄位命名標準化

### 統一的欄位命名規則

| 用途 | 欄位名稱 | 類型 | 說明 |
|------|---------|------|------|
| Stage ARN | `stageArn` | string | 完整的 ARN |
| Stage ID | `stageId` | string | 短 ID |
| 觀眾數量 | `viewerCount` | number | 特定 Stage 的觀眾數 |
| 總觀眾數 | `totalViewers` | number | 所有 Stage 的總和 |
| Stage 資訊 | `stageInfo` | object | Stage 元資料 |
| 是否為主 Stage | `isMasterStage` | boolean | 布林值 |
| 主播是否直播 | `isPublisherLive` | boolean | 布林值 |
| 觀看時長 | `watchDurationSeconds` | number | 秒數 |
| 心跳更新 | `heartbeatUpdated` | boolean | 布林值 |
| 觀眾離開 | `viewerLeft` | boolean | 布林值 |

---

## 🔍 驗證改進

### 詳細的缺失欄位提示

**之前**:
```json
{
  "error": "VALIDATION_ERROR",
  "message": "缺少必要參數"
}
```

**之後**:
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "缺少必要參數",
    "details": {
      "missingFields": ["userId", "stageArn"]
    }
  },
  "timestamp": "2025-10-21T10:30:00.000Z"
}
```

---

## 📈 API 端點對照表

### 所有端點的回應格式已統一

| 路由 | 端點 | 方法 | 變更 |
|------|------|------|------|
| **Token** | `/api/token/publisher` | POST | ✅ 統一格式 |
| | `/api/token/viewer` | POST | ✅ 統一格式 |
| | `/api/token/mediaserver` | POST | ✅ 統一格式 + 改進驗證 |
| **Stats** | `/api/stats` | GET | ✅ 統一格式 |
| | `/api/stats/viewers` | GET | ✅ 統一格式 |
| | `/api/stats/stages` | GET | ✅ 統一格式 |
| | `/api/stats/stages/:stageId` | GET | ✅ 統一格式 |
| | `/api/stats/publisher` | GET | ✅ 統一格式 |
| **Stage** | `/api/stage/list` | GET | ✅ 統一格式 |
| | `/api/stage/master/info` | GET | ✅ 統一格式 |
| | `/api/stage` | POST | ✅ 統一格式 |
| | `/api/stage/:stageArn` | GET | ✅ 統一格式 |
| | `/api/stage/:stageArn` | PUT | ✅ 統一格式 |
| | `/api/stage/:stageArn` | DELETE | ✅ 統一格式 + 訊息 |
| **Viewer** | `/api/viewer/rejoin` | POST | ✅ 統一格式 + 訊息 |
| | `/api/viewer/heartbeat` | POST | ✅ 統一格式 + 訊息 |
| | `/api/viewer/leave` | POST | ✅ 統一格式 + 訊息 |
| | `/api/viewer/list/:stageArn` | GET | ✅ 統一格式 |
| | `/api/viewer/duration` | GET | ✅ 統一格式 |
| **Health** | `/health` | GET | ✅ 統一格式 |
| | `/api/health` | GET | ✅ 統一格式 |

---

## 🎯 優點與好處

### 1. **客戶端開發更簡單**
- 所有 API 回應結構一致
- 錯誤處理邏輯統一
- 不需要為每個端點寫不同的處理邏輯

### 2. **更好的錯誤診斷**
- 詳細的缺失欄位列表
- 開發環境下提供詳細錯誤資訊
- 時間戳記方便追蹤

### 3. **程式碼維護性提升**
- 集中管理回應邏輯
- 減少重複程式碼
- 更容易擴展和修改

### 4. **符合 RESTful 最佳實踐**
- 標準化的 HTTP 狀態碼使用
- 一致的資料結構
- 清晰的成功/失敗標識

---

## 🔄 向後兼容性

### 主要變更

⚠️ **注意**: 這是一個 **破壞性變更 (Breaking Change)**

所有 API 回應格式已更改。客戶端需要更新以適應新格式。

### 遷移指南

**之前的回應格式**:
```json
{
  "success": true,
  "data": { ... },
  "timestamp": "2025-10-21T..."
}
```

**新的回應格式**:
```json
{
  "success": true,
  "data": { ... },
  "timestamp": "2025-10-21T..."
}
```

實際上，**成功回應格式完全相同**，主要是錯誤回應格式的統一。

---

## ✅ 測試建議

### 需要測試的端點

1. **Token 生成**
   - `POST /api/token/publisher`
   - `POST /api/token/viewer`
   - `POST /api/token/mediaserver`

2. **統計資料**
   - `GET /api/stats`
   - `GET /api/stats/viewers`
   - `GET /api/stats/stages`

3. **Stage 管理**
   - `GET /api/stage/list`
   - `POST /api/stage`
   - `DELETE /api/stage/:stageArn`

4. **觀眾管理**
   - `POST /api/viewer/heartbeat`
   - `POST /api/viewer/leave`
   - `GET /api/viewer/list/:stageArn`

5. **健康檢查**
   - `GET /health`

### 測試項目

- ✅ 成功回應包含 `success: true`, `data`, `timestamp`
- ✅ 錯誤回應包含 `success: false`, `error`, `timestamp`
- ✅ 驗證錯誤提供 `missingFields` 列表
- ✅ 所有欄位命名一致

---

## 📝 後續建議

### 短期改進

1. **添加請求驗證層**
   - 使用 Joi 或 Express Validator
   - 統一驗證邏輯

2. **API 文檔更新**
   - 更新 Swagger/OpenAPI 文檔
   - 提供範例回應

### 中期改進

1. **實現 DynamoDB 持久化**
   - 替代 Redis 單點依賴
   - 數據持久化

2. **WebSocket 完善**
   - 添加認證機制
   - 實現自動重連

3. **監控告警**
   - CloudWatch 整合
   - 錯誤率監控

---

## 📚 相關文件

- `API_DOCUMENTATION.md` - 完整 API 文檔
- `FIXES_2025-10-19.md` - 前次修復記錄
- `DATA_FLOW.md` - 數據流圖

---

## 👨‍💻 作者

**Claude** - AI 輔助開發
**日期**: 2025-10-21
**版本**: 1.1.0

---

## 📄 授權

與主專案相同
