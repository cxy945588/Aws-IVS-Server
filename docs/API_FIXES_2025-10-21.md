# API è¨­è¨ˆä¿®æ­£å ±å‘Š

**æ—¥æœŸ**: 2025-10-21
**ä¿®æ­£ç¯„åœ**: å…¨é¢å„ªåŒ– API è¨­è¨ˆï¼Œçµ±ä¸€å›æ‡‰æ ¼å¼å’ŒéŒ¯èª¤è™•ç†

---

## ğŸ“‹ ä¿®æ­£æ¦‚è¦

æœ¬æ¬¡ä¿®æ­£é‡å° AWS IVS Server API çš„è¨­è¨ˆä¸ä¸€è‡´å•é¡Œé€²è¡Œå…¨é¢å„ªåŒ–ï¼Œç¢ºä¿æ‰€æœ‰ API ç«¯é»éµå¾ªçµ±ä¸€çš„æ¨™æº–ã€‚

### ä¸»è¦æ”¹é€²

1. âœ… **çµ±ä¸€å›æ‡‰æ ¼å¼** - æ‰€æœ‰æˆåŠŸå›æ‡‰åŒ…å« `success`, `data`, `timestamp`
2. âœ… **çµ±ä¸€éŒ¯èª¤è™•ç†** - æ¨™æº–åŒ–éŒ¯èª¤å›æ‡‰çµæ§‹
3. âœ… **çµ±ä¸€æ¬„ä½å‘½å** - ç¢ºä¿æ‰€æœ‰ API ä½¿ç”¨ä¸€è‡´çš„æ¬„ä½åç¨±
4. âœ… **æ”¹é€²é©—è­‰é‚è¼¯** - è©³ç´°çš„ç¼ºå¤±æ¬„ä½æç¤º
5. âœ… **å‰µå»º Helper å‡½æ•¸** - çµ±ä¸€çš„å›æ‡‰å·¥å…·å‡½æ•¸

---

## ğŸ”§ ä¿®æ­£è©³æƒ…

### 1. æ–°å¢ Response Helper å·¥å…· (`utils/responseHelper.ts`)

å‰µå»ºäº†çµ±ä¸€çš„å›æ‡‰è™•ç†å·¥å…·ï¼ŒåŒ…å«ä»¥ä¸‹å‡½æ•¸ï¼š

```typescript
// æˆåŠŸå›æ‡‰
sendSuccess(res, data, statusCode?, message?)

// éŒ¯èª¤å›æ‡‰
sendError(res, errorCode, message, statusCode?, details?)
sendValidationError(res, message, missingFields?)
sendUnauthorized(res, message?)
sendForbidden(res, message?)
sendNotFound(res, resource?)
sendInternalError(res, error, customMessage?)
```

#### æ¨™æº–å›æ‡‰æ ¼å¼

**æˆåŠŸå›æ‡‰**:
```json
{
  "success": true,
  "data": { ... },
  "timestamp": "2025-10-21T10:30:00.000Z",
  "message": "optional message"
}
```

**éŒ¯èª¤å›æ‡‰**:
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "éŒ¯èª¤èªªæ˜",
    "details": "åƒ…é–‹ç™¼ç’°å¢ƒé¡¯ç¤º"
  },
  "timestamp": "2025-10-21T10:30:00.000Z"
}
```

---

### 2. ä¿®æ­£çš„è·¯ç”±æ–‡ä»¶

#### ğŸ“ `routes/stats.ts` - çµ±è¨ˆè³‡æ–™è·¯ç”±

**ä¿®æ­£å…§å®¹**:
- âœ… æ‰€æœ‰å›æ‡‰ä½¿ç”¨ `sendSuccess()`
- âœ… æ‰€æœ‰éŒ¯èª¤ä½¿ç”¨ `sendInternalError()`
- âœ… é©—è­‰éŒ¯èª¤ä½¿ç”¨ `sendError()` ä¸¦æä¾›è©³ç´°æç¤º
- âœ… æ¬„ä½å‘½åçµ±ä¸€ï¼š`stageArn`, `viewerCount`, `stageInfo`

**ä¸»è¦è®Šæ›´**:
```typescript
// ä¹‹å‰
res.status(200).json({
  success: true,
  data: { ... },
  timestamp: new Date().toISOString()
});

// ä¹‹å¾Œ
sendSuccess(res, { ... });
```

---

#### ğŸ“ `routes/stage.ts` - Stage ç®¡ç†è·¯ç”±

**ä¿®æ­£å…§å®¹**:
- âœ… ä½¿ç”¨å®Œæ•´çš„ helper å‡½æ•¸é›†
- âœ… `sendValidationError()` æä¾›ç¼ºå¤±æ¬„ä½åˆ—è¡¨
- âœ… `sendNotFound()` æ›¿ä»£æ‰‹å‹•æ§‹å»º 404 å›æ‡‰
- âœ… `sendForbidden()` è™•ç†ç¦æ­¢æ“ä½œ
- âœ… çµ±ä¸€æ¬„ä½å‘½åï¼š`isMasterStage` (å¸ƒæ—å€¼)

**ä¸»è¦è®Šæ›´**:
```typescript
// é©—è­‰éŒ¯èª¤ - ä¹‹å‰
if (!name) {
  return res.status(400).json({
    error: 'VALIDATION_ERROR',
    message: 'ç¼ºå°‘ name åƒæ•¸',
  });
}

// é©—è­‰éŒ¯èª¤ - ä¹‹å¾Œ
if (!name) {
  return sendValidationError(res, 'ç¼ºå°‘ name åƒæ•¸', ['name']);
}
```

---

#### ğŸ“ `routes/token.ts` - Token ç”Ÿæˆè·¯ç”±

**ä¿®æ­£å…§å®¹**:
- âœ… ä¸»æ’­ Token å›æ‡‰åŒ…å«å®Œæ•´çš„ OBS é…ç½®æŒ‡å—
- âœ… è§€çœ¾ Token è‡ªå‹•åˆ†é…é‚è¼¯ä¿æŒä¸è®Š
- âœ… Media Server Token å¢å¼·é©—è­‰
- âœ… æ‰€æœ‰éŒ¯èª¤å›æ‡‰æ¨™æº–åŒ–

**ä¸»è¦è®Šæ›´**:
```typescript
// ä¸»æ’­ Token å›æ‡‰ - ä¿ç•™ instructions ä½†çµ±ä¸€æ ¼å¼
sendSuccess(res, {
  token: token.token,
  participantId: token.participantId,
  userId: token.userId,
  stageArn: token.stageArn,
  capabilities: token.capabilities,
  expiresAt: token.expiresAt,
  whipEndpoint: API_ENDPOINTS.WHIP,
  expiresIn: Math.floor((token.expiresAt.getTime() - Date.now()) / 1000),
  instructions: {
    obs: { ... },
    web: { ... }
  }
});
```

---

#### ğŸ“ `routes/viewer.ts` - è§€çœ¾ç®¡ç†è·¯ç”±

**ä¿®æ­£å…§å®¹**:
- âœ… æ‰€æœ‰ POST ç«¯é»ä½¿ç”¨æ¨™æº–å›æ‡‰
- âœ… é©—è­‰éŒ¯èª¤æä¾›è©³ç´°çš„ç¼ºå¤±æ¬„ä½
- âœ… æ¬„ä½å‘½åçµ±ä¸€ï¼š`heartbeatUpdated`, `viewerLeft`, `watchDurationSeconds`
- âœ… æˆåŠŸè¨Šæ¯é€šé `message` åƒæ•¸å‚³é

**ä¸»è¦è®Šæ›´**:
```typescript
// å¿ƒè·³æ›´æ–° - ä¹‹å‰
res.status(200).json({
  success: true,
  message: 'å¿ƒè·³æ›´æ–°æˆåŠŸ',
  timestamp: new Date().toISOString(),
});

// å¿ƒè·³æ›´æ–° - ä¹‹å¾Œ
sendSuccess(res, {
  userId,
  stageArn,
  heartbeatUpdated: true,
}, HTTP_STATUS.OK, 'å¿ƒè·³æ›´æ–°æˆåŠŸ');
```

---

#### ğŸ“ `routes/health.ts` - å¥åº·æª¢æŸ¥è·¯ç”±

**ä¿®æ­£å…§å®¹**:
- âœ… ä½¿ç”¨ `sendSuccess()` å›æ‡‰
- âœ… éŒ¯èª¤å›æ‡‰ä½¿ç”¨æ¨™æº–æ ¼å¼
- âœ… ç‹€æ…‹æ¬„ä½æ”¹ç‚º `status: 'healthy'`

**ä¸»è¦è®Šæ›´**:
```typescript
// ä¹‹å‰
res.json({
  status: 'ok',
  timestamp: new Date().toISOString(),
  ...
});

// ä¹‹å¾Œ
sendSuccess(res, {
  status: 'healthy',
  uptime: process.uptime(),
  environment: process.env.NODE_ENV,
  ...
});
```

---

## ğŸ“Š æ¬„ä½å‘½åæ¨™æº–åŒ–

### çµ±ä¸€çš„æ¬„ä½å‘½åè¦å‰‡

| ç”¨é€” | æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ |
|------|---------|------|------|
| Stage ARN | `stageArn` | string | å®Œæ•´çš„ ARN |
| Stage ID | `stageId` | string | çŸ­ ID |
| è§€çœ¾æ•¸é‡ | `viewerCount` | number | ç‰¹å®š Stage çš„è§€çœ¾æ•¸ |
| ç¸½è§€çœ¾æ•¸ | `totalViewers` | number | æ‰€æœ‰ Stage çš„ç¸½å’Œ |
| Stage è³‡è¨Š | `stageInfo` | object | Stage å…ƒè³‡æ–™ |
| æ˜¯å¦ç‚ºä¸» Stage | `isMasterStage` | boolean | å¸ƒæ—å€¼ |
| ä¸»æ’­æ˜¯å¦ç›´æ’­ | `isPublisherLive` | boolean | å¸ƒæ—å€¼ |
| è§€çœ‹æ™‚é•· | `watchDurationSeconds` | number | ç§’æ•¸ |
| å¿ƒè·³æ›´æ–° | `heartbeatUpdated` | boolean | å¸ƒæ—å€¼ |
| è§€çœ¾é›¢é–‹ | `viewerLeft` | boolean | å¸ƒæ—å€¼ |

---

## ğŸ” é©—è­‰æ”¹é€²

### è©³ç´°çš„ç¼ºå¤±æ¬„ä½æç¤º

**ä¹‹å‰**:
```json
{
  "error": "VALIDATION_ERROR",
  "message": "ç¼ºå°‘å¿…è¦åƒæ•¸"
}
```

**ä¹‹å¾Œ**:
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "ç¼ºå°‘å¿…è¦åƒæ•¸",
    "details": {
      "missingFields": ["userId", "stageArn"]
    }
  },
  "timestamp": "2025-10-21T10:30:00.000Z"
}
```

---

## ğŸ“ˆ API ç«¯é»å°ç…§è¡¨

### æ‰€æœ‰ç«¯é»çš„å›æ‡‰æ ¼å¼å·²çµ±ä¸€

| è·¯ç”± | ç«¯é» | æ–¹æ³• | è®Šæ›´ |
|------|------|------|------|
| **Token** | `/api/token/publisher` | POST | âœ… çµ±ä¸€æ ¼å¼ |
| | `/api/token/viewer` | POST | âœ… çµ±ä¸€æ ¼å¼ |
| | `/api/token/mediaserver` | POST | âœ… çµ±ä¸€æ ¼å¼ + æ”¹é€²é©—è­‰ |
| **Stats** | `/api/stats` | GET | âœ… çµ±ä¸€æ ¼å¼ |
| | `/api/stats/viewers` | GET | âœ… çµ±ä¸€æ ¼å¼ |
| | `/api/stats/stages` | GET | âœ… çµ±ä¸€æ ¼å¼ |
| | `/api/stats/stages/:stageId` | GET | âœ… çµ±ä¸€æ ¼å¼ |
| | `/api/stats/publisher` | GET | âœ… çµ±ä¸€æ ¼å¼ |
| **Stage** | `/api/stage/list` | GET | âœ… çµ±ä¸€æ ¼å¼ |
| | `/api/stage/master/info` | GET | âœ… çµ±ä¸€æ ¼å¼ |
| | `/api/stage` | POST | âœ… çµ±ä¸€æ ¼å¼ |
| | `/api/stage/:stageArn` | GET | âœ… çµ±ä¸€æ ¼å¼ |
| | `/api/stage/:stageArn` | PUT | âœ… çµ±ä¸€æ ¼å¼ |
| | `/api/stage/:stageArn` | DELETE | âœ… çµ±ä¸€æ ¼å¼ + è¨Šæ¯ |
| **Viewer** | `/api/viewer/rejoin` | POST | âœ… çµ±ä¸€æ ¼å¼ + è¨Šæ¯ |
| | `/api/viewer/heartbeat` | POST | âœ… çµ±ä¸€æ ¼å¼ + è¨Šæ¯ |
| | `/api/viewer/leave` | POST | âœ… çµ±ä¸€æ ¼å¼ + è¨Šæ¯ |
| | `/api/viewer/list/:stageArn` | GET | âœ… çµ±ä¸€æ ¼å¼ |
| | `/api/viewer/duration` | GET | âœ… çµ±ä¸€æ ¼å¼ |
| **Health** | `/health` | GET | âœ… çµ±ä¸€æ ¼å¼ |
| | `/api/health` | GET | âœ… çµ±ä¸€æ ¼å¼ |

---

## ğŸ¯ å„ªé»èˆ‡å¥½è™•

### 1. **å®¢æˆ¶ç«¯é–‹ç™¼æ›´ç°¡å–®**
- æ‰€æœ‰ API å›æ‡‰çµæ§‹ä¸€è‡´
- éŒ¯èª¤è™•ç†é‚è¼¯çµ±ä¸€
- ä¸éœ€è¦ç‚ºæ¯å€‹ç«¯é»å¯«ä¸åŒçš„è™•ç†é‚è¼¯

### 2. **æ›´å¥½çš„éŒ¯èª¤è¨ºæ–·**
- è©³ç´°çš„ç¼ºå¤±æ¬„ä½åˆ—è¡¨
- é–‹ç™¼ç’°å¢ƒä¸‹æä¾›è©³ç´°éŒ¯èª¤è³‡è¨Š
- æ™‚é–“æˆ³è¨˜æ–¹ä¾¿è¿½è¹¤

### 3. **ç¨‹å¼ç¢¼ç¶­è­·æ€§æå‡**
- é›†ä¸­ç®¡ç†å›æ‡‰é‚è¼¯
- æ¸›å°‘é‡è¤‡ç¨‹å¼ç¢¼
- æ›´å®¹æ˜“æ“´å±•å’Œä¿®æ”¹

### 4. **ç¬¦åˆ RESTful æœ€ä½³å¯¦è¸**
- æ¨™æº–åŒ–çš„ HTTP ç‹€æ…‹ç¢¼ä½¿ç”¨
- ä¸€è‡´çš„è³‡æ–™çµæ§‹
- æ¸…æ™°çš„æˆåŠŸ/å¤±æ•—æ¨™è­˜

---

## ğŸ”„ å‘å¾Œå…¼å®¹æ€§

### ä¸»è¦è®Šæ›´

âš ï¸ **æ³¨æ„**: é€™æ˜¯ä¸€å€‹ **ç ´å£æ€§è®Šæ›´ (Breaking Change)**

æ‰€æœ‰ API å›æ‡‰æ ¼å¼å·²æ›´æ”¹ã€‚å®¢æˆ¶ç«¯éœ€è¦æ›´æ–°ä»¥é©æ‡‰æ–°æ ¼å¼ã€‚

### é·ç§»æŒ‡å—

**ä¹‹å‰çš„å›æ‡‰æ ¼å¼**:
```json
{
  "success": true,
  "data": { ... },
  "timestamp": "2025-10-21T..."
}
```

**æ–°çš„å›æ‡‰æ ¼å¼**:
```json
{
  "success": true,
  "data": { ... },
  "timestamp": "2025-10-21T..."
}
```

å¯¦éš›ä¸Šï¼Œ**æˆåŠŸå›æ‡‰æ ¼å¼å®Œå…¨ç›¸åŒ**ï¼Œä¸»è¦æ˜¯éŒ¯èª¤å›æ‡‰æ ¼å¼çš„çµ±ä¸€ã€‚

---

## âœ… æ¸¬è©¦å»ºè­°

### éœ€è¦æ¸¬è©¦çš„ç«¯é»

1. **Token ç”Ÿæˆ**
   - `POST /api/token/publisher`
   - `POST /api/token/viewer`
   - `POST /api/token/mediaserver`

2. **çµ±è¨ˆè³‡æ–™**
   - `GET /api/stats`
   - `GET /api/stats/viewers`
   - `GET /api/stats/stages`

3. **Stage ç®¡ç†**
   - `GET /api/stage/list`
   - `POST /api/stage`
   - `DELETE /api/stage/:stageArn`

4. **è§€çœ¾ç®¡ç†**
   - `POST /api/viewer/heartbeat`
   - `POST /api/viewer/leave`
   - `GET /api/viewer/list/:stageArn`

5. **å¥åº·æª¢æŸ¥**
   - `GET /health`

### æ¸¬è©¦é …ç›®

- âœ… æˆåŠŸå›æ‡‰åŒ…å« `success: true`, `data`, `timestamp`
- âœ… éŒ¯èª¤å›æ‡‰åŒ…å« `success: false`, `error`, `timestamp`
- âœ… é©—è­‰éŒ¯èª¤æä¾› `missingFields` åˆ—è¡¨
- âœ… æ‰€æœ‰æ¬„ä½å‘½åä¸€è‡´

---

## ğŸ“ å¾ŒçºŒå»ºè­°

### çŸ­æœŸæ”¹é€²

1. **æ·»åŠ è«‹æ±‚é©—è­‰å±¤**
   - ä½¿ç”¨ Joi æˆ– Express Validator
   - çµ±ä¸€é©—è­‰é‚è¼¯

2. **API æ–‡æª”æ›´æ–°**
   - æ›´æ–° Swagger/OpenAPI æ–‡æª”
   - æä¾›ç¯„ä¾‹å›æ‡‰

### ä¸­æœŸæ”¹é€²

1. **å¯¦ç¾ DynamoDB æŒä¹…åŒ–**
   - æ›¿ä»£ Redis å–®é»ä¾è³´
   - æ•¸æ“šæŒä¹…åŒ–

2. **WebSocket å®Œå–„**
   - æ·»åŠ èªè­‰æ©Ÿåˆ¶
   - å¯¦ç¾è‡ªå‹•é‡é€£

3. **ç›£æ§å‘Šè­¦**
   - CloudWatch æ•´åˆ
   - éŒ¯èª¤ç‡ç›£æ§

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- `API_DOCUMENTATION.md` - å®Œæ•´ API æ–‡æª”
- `FIXES_2025-10-19.md` - å‰æ¬¡ä¿®å¾©è¨˜éŒ„
- `DATA_FLOW.md` - æ•¸æ“šæµåœ–

---

## ğŸ‘¨â€ğŸ’» ä½œè€…

**Claude** - AI è¼”åŠ©é–‹ç™¼
**æ—¥æœŸ**: 2025-10-21
**ç‰ˆæœ¬**: 1.1.0

---

## ğŸ“„ æˆæ¬Š

èˆ‡ä¸»å°ˆæ¡ˆç›¸åŒ
