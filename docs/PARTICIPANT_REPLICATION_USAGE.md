# Participant Replication å¯¦éš›ä½¿ç”¨æŒ‡å—

## å•é¡Œèªªæ˜

ä½ é‡åˆ°çš„éŒ¯èª¤ï¼š
```
"5hFsPVjAYDnT is not publishing"
```

é€™æ˜¯ **AWS IVS çš„æ­£å¸¸é™åˆ¶**ï¼Œä¸æ˜¯ bugã€‚

## AWS IVS Participant Replication è¦æ±‚

### âœ… å¿…é ˆæ»¿è¶³çš„æ¢ä»¶

è¦æˆåŠŸå•Ÿå‹• Participant Replicationï¼Œä¸»æ’­å¿…é ˆï¼š

1. âœ… å·²ç²å¾— Tokenï¼ˆæœ‰ participantIdï¼‰
2. âœ… **å·²é€£æ¥åˆ° Stage**
3. âœ… **æ­£åœ¨æ¨æµï¼ˆpublishing ç‹€æ…‹ï¼‰**

### âŒ ä¸æ»¿è¶³çš„æƒ…æ³

ä»¥ä¸‹æƒ…æ³æœƒå¤±æ•—ï¼š

- âŒ åªç”Ÿæˆäº† Tokenï¼Œä½†é‚„æ²’é€£æ¥åˆ° Stage
- âŒ å·²é€£æ¥åˆ° Stageï¼Œä½†é‚„æ²’é–‹å§‹æ¨æµ
- âŒ æ¨æµå·²åœæ­¢

## å¯¦éš›ä½¿ç”¨å ´æ™¯

### å ´æ™¯ 1ï¼šè‡ªå‹•æ“´å±•ï¼ˆæ¨è–¦ï¼‰

é€™æ˜¯æœ€å¸¸è¦‹çš„ä½¿ç”¨å ´æ™¯ï¼Œç³»çµ±æœƒè‡ªå‹•è™•ç†ã€‚

**æµç¨‹ï¼š**

1. **ä¸»æ’­é–‹æ’­**
   ```
   ä¸»æ’­ â†’ ç²å– Token â†’ é€£æ¥åˆ° Master Stage â†’ é–‹å§‹æ¨æµ
   ```

2. **è§€çœ¾åŠ å…¥**
   ```
   è§€çœ¾1 â†’ åˆ†é…åˆ° Master Stage
   è§€çœ¾2 â†’ åˆ†é…åˆ° Master Stage
   ...
   è§€çœ¾50 â†’ Master Stage å¿«æ»¿äº†
   ```

3. **è‡ªå‹•æ“´å±•è§¸ç™¼**
   ```
   ç³»çµ±æª¢æ¸¬åˆ°è§€çœ¾æ•¸ â‰¥ 45 â†’ è‡ªå‹•å‰µå»º Stage B
   ```

4. **Participant Replication è‡ªå‹•å•Ÿå‹•**
   ```
   ç³»çµ±æª¢æŸ¥ï¼šä¸»æ’­åœ¨æ¨æµå—ï¼Ÿ
   âœ… æ˜¯ â†’ è‡ªå‹•å•Ÿå‹• Replicationï¼ˆä¸»æ’­ç•«é¢è¤‡è£½åˆ° Stage Bï¼‰
   âŒ å¦ â†’ è·³éï¼ˆè¨˜éŒ„è­¦å‘Šï¼‰
   ```

5. **æ–°è§€çœ¾è‡ªå‹•åˆ†é…**
   ```
   è§€çœ¾51 â†’ åˆ†é…åˆ° Stage Bï¼ˆèƒ½çœ‹åˆ°ä¸»æ’­ç•«é¢ï¼‰
   è§€çœ¾52 â†’ åˆ†é…åˆ° Stage B
   ```

**ä»£ç¢¼å¯¦ç¾ï¼š**

å·²ç¶“åœ¨ `StageAutoScalingService.ts` çš„ `scaleUp()` æ–¹æ³•ä¸­å¯¦ç¾ï¼š

```typescript
// å‰µå»ºæ–° Stage å¾Œ
if (publisherInfo && publisherInfo.participantId) {
  try {
    await ivsService.startParticipantReplication(
      publisherInfo.stageArn,    // Master Stage
      newStageArn,               // æ–° Stage
      publisherInfo.participantId
    );
  } catch (error) {
    if (error.message.includes('not publishing')) {
      // ä¸»æ’­é‚„æ²’æ¨æµï¼Œé€™æ˜¯æ­£å¸¸çš„ï¼Œè·³é
      logger.warn('ä¸»æ’­å°šæœªé–‹å§‹æ¨æµï¼Œæš«æ™‚è·³é Replication');
    }
  }
}
```

### å ´æ™¯ 2ï¼šæ‰‹å‹•ç®¡ç†

å¦‚æœéœ€è¦æ‰‹å‹•æ§åˆ¶ Replicationã€‚

**æ­¥é©Ÿï¼š**

1. **ç¢ºèªä¸»æ’­æ­£åœ¨æ¨æµ**
   ```bash
   curl http://localhost:3000/api/stage/replication/publisher-info
   ```

   å›æ‡‰ï¼š
   ```json
   {
     "hasPublisher": true,
     "publisherInfo": {
       "participantId": "xxx",
       "stageArn": "arn:aws:ivs:...:stage/master",
       "userId": "broadcaster-123"
     }
   }
   ```

2. **å‰µå»ºæ–° Stage**
   ```bash
   curl -X POST http://localhost:3000/api/stage \
     -H "Content-Type: application/json" \
     -d '{"name": "stage-2"}'
   ```

3. **æ‰‹å‹•å•Ÿå‹• Replication**
   ```bash
   curl -X POST http://localhost:3000/api/stage/replication/start \
     -H "Content-Type: application/json" \
     -d '{
       "sourceStageArn": "arn:aws:ivs:...:stage/master",
       "destinationStageArn": "arn:aws:ivs:...:stage/stage-2",
       "participantId": "xxx"
     }'
   ```

   **æˆåŠŸï¼š**
   ```json
   {
     "success": true,
     "message": "Participant Replication å·²å•Ÿå‹•"
   }
   ```

   **å¤±æ•—ï¼ˆä¸»æ’­æœªæ¨æµï¼‰ï¼š**
   ```json
   {
     "success": false,
     "message": "xxx is not publishing"
   }
   ```

### å ´æ™¯ 3ï¼šæ¸¬è©¦ç’°å¢ƒ

åœ¨æ¸¬è©¦ç’°å¢ƒä¸­ï¼Œå¦‚æœåªæƒ³æ¸¬è©¦ API è€Œä¸çœŸæ­£æ¨æµã€‚

**é¸é … Aï¼šè·³é Replication æ¸¬è©¦**

æ¸¬è©¦è…³æœ¬å·²ç¶“è™•ç†äº†é€™ç¨®æƒ…æ³ï¼š

```bash
node test-participant-replication.js
```

è¼¸å‡ºï¼š
```
æ­¥é©Ÿ 4ï¼šå•Ÿå‹• Participant Replication
âš ï¸ æ³¨æ„ï¼šParticipant Replication è¦æ±‚ä¸»æ’­å¿…é ˆæ­£åœ¨æ¨æµï¼ˆpublishingï¼‰
âš ï¸ é æœŸçš„å¤±æ•—ï¼šä¸»æ’­å°šæœªé–‹å§‹æ¨æµ
   é€™æ˜¯æ­£å¸¸æƒ…æ³ï¼Œå¯¦éš›ä½¿ç”¨æ™‚ï¼š
   1. ä¸»æ’­é€£æ¥åˆ° Stage ä¸¦é–‹å§‹æ¨æµå¾Œ
   2. è‡ªå‹•æ“´å±•å‰µå»ºæ–° Stage æ™‚
   3. ç³»çµ±æœƒè‡ªå‹•å•Ÿå‹• Participant Replication

âœ“ æ­¥é©Ÿ 4 å·²è·³éï¼ˆä¸»æ’­æœªæ¨æµæ˜¯æ­£å¸¸æƒ…æ³ï¼‰
```

**é¸é … Bï¼šä½¿ç”¨çœŸå¯¦ä¸»æ’­æ¨æµ**

1. ä½¿ç”¨ OBS æˆ–å…¶ä»–æ¨æµå·¥å…·
2. ç²å–ä¸»æ’­ Token
3. é€£æ¥åˆ° Stage ä¸¦é–‹å§‹æ¨æµ
4. ç„¶å¾Œé‹è¡Œæ¸¬è©¦è…³æœ¬

## å®Œæ•´çš„å·¥ä½œæµç¨‹ç¤ºä¾‹

### ç¤ºä¾‹ï¼šç›´æ’­å¹³å°æ“´å±•æµç¨‹

```
æ™‚é–“ç·šï¼š

T=0s
â”œâ”€ ä¸»æ’­é–‹æ’­ï¼ˆç²å– Tokenï¼Œé€£æ¥åˆ° Master Stageï¼‰
â”œâ”€ é–‹å§‹æ¨æµ
â””â”€ Redis è¨˜éŒ„ä¸»æ’­è³‡è¨Šï¼ˆparticipantId: abc123ï¼‰

T=30s
â”œâ”€ è§€çœ¾é™¸çºŒåŠ å…¥ Master Stage
â””â”€ ç•¶å‰è§€çœ¾æ•¸ï¼š45

T=60s
â”œâ”€ ç³»çµ±æª¢æ¸¬åˆ°è§€çœ¾æ•¸ â‰¥ 45
â”œâ”€ è§¸ç™¼è‡ªå‹•æ“´å±•
â”œâ”€ å‰µå»º Stage-2
â””â”€ å•Ÿå‹• Participant Replication
    â”œâ”€ æª¢æŸ¥ï¼šä¸»æ’­åœ¨æ¨æµå—ï¼Ÿ
    â”œâ”€ âœ… æ˜¯ï¼ˆabc123 æ­£åœ¨ publishingï¼‰
    â”œâ”€ èª¿ç”¨ StartParticipantReplication
    â”‚   â”œâ”€ sourceStageArn: Master Stage
    â”‚   â”œâ”€ destinationStageArn: Stage-2
    â”‚   â””â”€ participantId: abc123
    â””â”€ âœ… æˆåŠŸï¼ä¸»æ’­ç•«é¢å·²è¤‡è£½åˆ° Stage-2

T=65s
â”œâ”€ æ–°è§€çœ¾åŠ å…¥
â”œâ”€ è‡ªå‹•åˆ†é…åˆ° Stage-2
â””â”€ âœ… èƒ½çœ‹åˆ°ä¸»æ’­ç•«é¢ï¼ˆç„¡éœ€ä¸»æ’­æ¨ç¬¬äºŒæ¢æµï¼‰

T=120s
â”œâ”€ è§€çœ¾é›¢é–‹ï¼ŒStage-2 è§€çœ¾æ•¸é™åˆ° 0
â”œâ”€ è§¸ç™¼è‡ªå‹•ç¸®æ¸›
â”œâ”€ åœæ­¢ Participant Replicationï¼ˆStage-2ï¼‰
â””â”€ åˆªé™¤ Stage-2
```

## å¸¸è¦‹å•é¡Œ FAQ

### Q1: æ¸¬è©¦è…³æœ¬ç‚ºä»€éº¼æœƒå¤±æ•—ï¼Ÿ

**A:** å› ç‚ºæ¸¬è©¦è…³æœ¬åªç”Ÿæˆäº† Tokenï¼Œä½†æ²’æœ‰çœŸæ­£è®“ä¸»æ’­æ¨æµã€‚é€™æ˜¯é æœŸè¡Œç‚ºï¼Œä¸æ˜¯ bugã€‚

### Q2: å¦‚ä½•è®“æ¸¬è©¦æˆåŠŸï¼Ÿ

**A:**
- é¸é … 1ï¼šæ¥å—æ¸¬è©¦æœƒè·³é Replication éƒ¨åˆ†ï¼ˆè…³æœ¬å·²è™•ç†ï¼‰
- é¸é … 2ï¼šä½¿ç”¨çœŸå¯¦æ¨æµå·¥å…·ï¼ˆOBSï¼‰é€²è¡Œå®Œæ•´æ¸¬è©¦

### Q3: ç”Ÿç”¢ç’°å¢ƒæœƒæœ‰å•é¡Œå—ï¼Ÿ

**A:** ä¸æœƒã€‚ç”Ÿç”¢ç’°å¢ƒä¸­ï¼š
1. ä¸»æ’­æœƒçœŸæ­£æ¨æµ
2. è‡ªå‹•æ“´å±•æœƒåœ¨ä¸»æ’­æ¨æµå¾Œæ‰è§¸ç™¼
3. Participant Replication æœƒæˆåŠŸ

### Q4: å¦‚æœä¸»æ’­é–‹æ’­å‰å°±æœ‰å¾ˆå¤šè§€çœ¾æ€éº¼è¾¦ï¼Ÿ

**A:**
1. ä¸»æ’­é–‹æ’­å‰ï¼Œè§€çœ¾æœƒæ”¶åˆ° "ä¸»æ’­æœªåœ¨ç·š" éŒ¯èª¤
2. ä¸»æ’­é–‹å§‹æ¨æµå¾Œï¼Œè§€çœ¾æ‰èƒ½ç²å– Token ä¸¦åŠ å…¥
3. æ­¤æ™‚ Participant Replication æœƒæ­£å¸¸å·¥ä½œ

### Q5: å¦‚æœ Replication å¤±æ•—æœƒå½±éŸ¿æœå‹™å—ï¼Ÿ

**A:** ä¸æœƒã€‚ä»£ç¢¼å·²ç¶“è™•ç†ï¼š
- Replication å¤±æ•—ä¸å½±éŸ¿ Stage å‰µå»º
- åªè¨˜éŒ„è­¦å‘Šæ—¥èªŒ
- æ–° Stage ä»ç„¶å¯ç”¨ï¼ˆåªæ˜¯æ²’æœ‰ä¸»æ’­ç•«é¢ï¼‰
- å¯ä»¥ä¹‹å¾Œæ‰‹å‹•å•Ÿå‹• Replication

## ç›£æ§å’Œæ—¥èªŒ

### æˆåŠŸçš„æ—¥èªŒ

```
2025-10-23 16:00:00 [info]: ğŸ”„ é–‹å§‹å•Ÿå‹• Participant Replication
2025-10-23 16:00:00 [info]: âœ… Participant Replication å·²å•Ÿå‹•
```

### ä¸»æ’­æœªæ¨æµçš„æ—¥èªŒ

```
2025-10-23 16:00:00 [warn]: âš ï¸ ä¸»æ’­å°šæœªé–‹å§‹æ¨æµï¼Œæš«æ™‚è·³é Participant Replication
2025-10-23 16:00:00 [warn]: ç•¶ä¸»æ’­é–‹å§‹æ¨æµå¾Œï¼Œå¯ä»¥æ‰‹å‹•å•Ÿå‹• Replication
```

### éŒ¯èª¤æ—¥èªŒ

```
2025-10-23 16:00:00 [error]: âŒ åƒèˆ‡è€…è¤‡è£½å•Ÿå‹•å¤±æ•—
2025-10-23 16:00:00 [error]: xxx is not publishing
```

## ç¸½çµ

âœ… **é—œéµè¦é»ï¼š**

1. Participant Replication è¦æ±‚ä¸»æ’­**æ­£åœ¨æ¨æµ**
2. æ¸¬è©¦ç’°å¢ƒä¸­ï¼Œä¸æ¨æµæ˜¯æ­£å¸¸çš„
3. ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œè‡ªå‹•æ“´å±•æœƒè‡ªå‹•è™•ç†
4. å¤±æ•—ä¸å½±éŸ¿æœå‹™é‹è¡Œ
5. å¯ä»¥æ‰‹å‹•é‡è©¦

âœ… **æœ€ä½³å¯¦è¸ï¼š**

1. è®“è‡ªå‹•æ“´å±•è™•ç† Replication
2. ç›£æ§æ—¥èªŒä»¥ç™¼ç¾å•é¡Œ
3. å¦‚éœ€æ‰‹å‹•ç®¡ç†ï¼Œç¢ºèªä¸»æ’­åœ¨æ¨æµ
4. æ¸¬è©¦æ™‚æ¥å— Replication æ­¥é©Ÿæœƒè·³é

ğŸ¯ **ä½ çš„å¯¦ç¾æ˜¯æ­£ç¢ºçš„ï¼** éŒ¯èª¤åªæ˜¯å› ç‚ºæ¸¬è©¦ç’°å¢ƒæ²’æœ‰çœŸå¯¦æ¨æµã€‚
