# æ¸¬è©¦æŒ‡å—

## æ¸¬è©¦å·¥å…·ç¸½è¦½

æœ¬å°ˆæ¡ˆæä¾›ä¸‰å€‹æ¸¬è©¦/è¨ºæ–·å·¥å…·ï¼Œå„æœ‰ä¸åŒç”¨é€”ï¼š

| å·¥å…· | ç”¨é€” | ä½¿ç”¨æ™‚æ©Ÿ |
|------|------|---------|
| `test-full-flow.js` | å®Œæ•´æµç¨‹æ¸¬è©¦ | æ¸¬è©¦è‡ªå‹•æ“´å±• + Participant Replication |
| `verify-replication.js` | API å±¤é¢è¨ºæ–· | æª¢æŸ¥ Replication é…ç½®ç‹€æ…‹ |
| `check-stage-participants.js` | AWS ç›´æ¥æŸ¥è©¢ | æŸ¥çœ‹ Stage å¯¦éš›åƒèˆ‡è€… |

---

## ğŸ§ª test-full-flow.js - å®Œæ•´æµç¨‹æ¸¬è©¦

### ç”¨é€”

æ¸¬è©¦å®Œæ•´çš„è‡ªå‹•æ“´å±•å’Œ Participant Replication æµç¨‹ã€‚

### æ¸¬è©¦é …ç›®

1. âœ… ä¸»æ’­ Token ç”Ÿæˆ
2. âœ… ç­‰å¾…ä¸»æ’­æ¨æµï¼ˆåœ¨ OBS ä¸­ï¼‰
3. âœ… æ¨¡æ“¬ 50 å€‹è§€çœ¾åŠ å…¥
4. âœ… è§¸ç™¼è‡ªå‹•æ“´å±•ï¼ˆé–¾å€¼ 45ï¼‰
5. âœ… é©—è­‰ Participant Replication
6. âœ… æä¾› AWS æ§åˆ¶å°éˆæ¥
7. âœ… æ¸…ç†æ¸¬è©¦è³‡æºï¼ˆå¯é¸ï¼‰

### ä½¿ç”¨æ–¹å¼

```bash
# ç¢ºä¿ API æœå‹™å™¨æ­£åœ¨é‹è¡Œ
cd /path/to/Aws-IVS-Server
node test-full-flow.js
```

### æ¸¬è©¦æµç¨‹

#### 1. å•Ÿå‹•æ¸¬è©¦

```bash
node test-full-flow.js
```

è¼¸å‡ºï¼š
```
============================================================
æ­¥é©Ÿ 1ï¼šç”Ÿæˆä¸»æ’­ Token
============================================================

âœ… ä¸»æ’­ Token ç”ŸæˆæˆåŠŸ

ğŸ“‹ ä¸»æ’­è³‡è¨Šï¼š
  - Participant ID: abc123xyz
  - User ID: test-full-flow-broadcaster
  - Stage ARN: arn:aws:ivs:us-east-1:...
  - Token æœ‰æ•ˆæœŸ: 7200 ç§’

ğŸ”‘ Tokenï¼ˆç”¨æ–¼æ¨æµï¼‰ï¼š
eyJhbGciOiJFUzM4NCIsInR5cCI6IkpXVCJ9...
```

#### 2. è¨­ç½® OBS æ¨æµ

æ¸¬è©¦æœƒæš«åœï¼Œç­‰å¾…ä½ åœ¨ OBS ä¸­è¨­ç½®æ¨æµï¼š

```
============================================================
æ­¥é©Ÿ 2ï¼šç­‰å¾…ä¸»æ’­é–‹å§‹æ¨æµ
============================================================

è«‹åœ¨ OBS ä¸­è¨­ç½®æ¨æµï¼š

ğŸ“º OBS è¨­ç½®ï¼š
1. è¨­å®š â†’ ä¸²æµ
2. æœå‹™ï¼šWHIP
3. æœå‹™å™¨ï¼šå¾ Stage ARN æå– WHIP ç«¯é»
4. Bearer Tokenï¼šä½¿ç”¨ä¸Šæ–¹é¡¯ç¤ºçš„ Token
5. é»æ“Šã€Œé–‹å§‹ä¸²æµã€

ğŸ’¡ æç¤ºï¼šæ¨æµæˆåŠŸå¾Œï¼ŒæŒ‰ Enter ç¹¼çºŒæ¸¬è©¦
```

**åœ¨ OBS ä¸­æ“ä½œï¼š**
1. æ‰“é–‹ OBS Studio
2. è¨­å®š â†’ ä¸²æµ
3. æœå‹™é¸æ“‡ "WHIP"
4. æœå‹™å™¨å¡«å¯« WHIP ç«¯é»ï¼ˆä¾‹å¦‚ï¼š`https://us-east-1.global-contribute.live-video.net`ï¼‰
5. Bearer Token ç²˜è²¼ä¸Šæ–¹çš„å®Œæ•´ Token
6. é»æ“Šã€Œé–‹å§‹ä¸²æµã€
7. ç¢ºèª OBS é¡¯ç¤ºã€Œä¸²æµä¸­ã€
8. **å›åˆ°çµ‚ç«¯æ©ŸæŒ‰ Enter ç¹¼çºŒ**

#### 3. æ¨¡æ“¬è§€çœ¾åŠ å…¥

```
============================================================
æ­¥é©Ÿ 3ï¼šæ¨¡æ“¬ 50 å€‹è§€çœ¾åŠ å…¥
============================================================

æ­£åœ¨æ¨¡æ“¬ 50 å€‹è§€çœ¾åŠ å…¥ Master Stage...

  å·²æ¨¡æ“¬ 10/50 å€‹è§€çœ¾...
  å·²æ¨¡æ“¬ 20/50 å€‹è§€çœ¾...
  ...
  å·²æ¨¡æ“¬ 50/50 å€‹è§€çœ¾...

âœ… æˆåŠŸæ¨¡æ“¬ 50 å€‹è§€çœ¾
```

#### 4. ç­‰å¾…è‡ªå‹•æ“´å±•

æ¸¬è©¦æœƒè‡ªå‹•ç­‰å¾…è‡ªå‹•æ“´å±•è§¸ç™¼ï¼ˆæœ€å¤š 5 åˆ†é˜ï¼‰ï¼š

```
============================================================
æ­¥é©Ÿ 4ï¼šç­‰å¾…è‡ªå‹•æ“´å±•è§¸ç™¼
============================================================

è‡ªå‹•æ“´å±•æª¢æŸ¥é€±æœŸï¼š30 ç§’
æ­£åœ¨ç­‰å¾…è‡ªå‹•æ“´å±•è§¸ç™¼...

â³ æª¢æŸ¥ 1/10 - æ‰¾åˆ° 1 å€‹ Stage (0 å€‹è‡ªå‹•æ“´å±•)
â³ æª¢æŸ¥ 2/10 - æ‰¾åˆ° 2 å€‹ Stage (1 å€‹è‡ªå‹•æ“´å±•)

âœ… æª¢æ¸¬åˆ°è‡ªå‹•æ“´å±•ï¼å‰µå»ºäº† 1 å€‹æ–° Stage

1. auto-stage-1730123456789
   ARN: arn:aws:ivs:us-east-1:...:stage/xyz789
   è§€çœ¾æ•¸: 0
```

#### 5. é©—è­‰ Replication

```
============================================================
æ­¥é©Ÿ 5ï¼šé©—è­‰ Participant Replication
============================================================

æª¢æŸ¥æ–°å‰µå»ºçš„ Stage æ˜¯å¦å•Ÿå‹•äº† Replication...

âœ… auto-stage-1730123456789 - Replication å·²å•Ÿå‹•
   - ä¾†æº Stage: ...stage/abc123
   - Participant ID: abc123xyz

ç¸½çµï¼š1/1 å€‹ Stage å•Ÿå‹•äº† Replication
```

#### 6. AWS æ§åˆ¶å°é©—è­‰

```
============================================================
æ­¥é©Ÿ 6ï¼šåœ¨ AWS æ§åˆ¶å°é©—è­‰
============================================================

è«‹åœ¨ AWS IVS æ§åˆ¶å°é©—è­‰çµæœï¼š

ğŸ”— AWS IVS Real-time æ§åˆ¶å°ï¼š
https://console.aws.amazon.com/ivs/home?region=us-east-1#/real-time/stages

ğŸ“‹ Master Stageï¼š
https://console.aws.amazon.com/ivs/home?region=us-east-1#/real-time/stages/abc123

ğŸ“‹ è‡ªå‹•æ“´å±•çš„ Stageï¼š
1. auto-stage-1730123456789
   https://console.aws.amazon.com/ivs/home?region=us-east-1#/real-time/stages/xyz789

âœ… é©—è­‰æ­¥é©Ÿï¼š
1. é»æ“Šä¸Šæ–¹é€£çµé€²å…¥ AWS æ§åˆ¶å°
2. æŸ¥çœ‹ Master Stage çš„ Participantsï¼ˆæ‡‰è©²æœ‰ 1 å€‹ Publisherï¼‰
3. æŸ¥çœ‹è‡ªå‹•æ“´å±• Stage çš„ Participantsï¼ˆæ‡‰è©²ä¹Ÿæœ‰ 1 å€‹ Publisher - è¤‡è£½çš„ï¼‰
4. ç¢ºèªå…©å€‹ Stage éƒ½é¡¯ç¤ºä¸»æ’­ç•«é¢
```

**åœ¨ AWS æ§åˆ¶å°ä¸­é©—è­‰ï¼š**
1. é»æ“Šæä¾›çš„éˆæ¥é€²å…¥ AWS æ§åˆ¶å°
2. æŸ¥çœ‹ **Master Stage**ï¼š
   - Participants æ¨™ç±¤
   - æ‡‰è©²çœ‹åˆ° 1 å€‹ Publisherï¼ˆä½ çš„ä¸»æ’­ï¼‰
   - ç‹€æ…‹ï¼šConnected, Publishing
3. æŸ¥çœ‹ **è‡ªå‹•æ“´å±•çš„ Stage**ï¼š
   - Participants æ¨™ç±¤
   - æ‡‰è©²ä¹Ÿçœ‹åˆ° 1 å€‹ Publisherï¼ˆé€šé Replication è¤‡è£½çš„ï¼‰
   - ç‹€æ…‹ï¼šConnected, Publishing
4. å¦‚æœçœ‹åˆ° "The stage currently has no publishers"ï¼š
   - è¡¨ç¤º Replication å¤±æ•—æˆ–ä¸»æ’­æ²’æœ‰æ¨æµ

#### 7. æ¸…ç†è³‡æº

```
============================================================
æ­¥é©Ÿ 7ï¼šæ¸…ç†æ¸¬è©¦è³‡æº
============================================================

æ˜¯å¦è¦æ¸…ç†æ¸¬è©¦è³‡æºï¼Ÿ(y/n)
é€™å°‡åˆªé™¤æ‰€æœ‰è‡ªå‹•æ“´å±•å‰µå»ºçš„ Stage

y

æ­£åœ¨æ¸…ç†...

âœ… å·²åˆªé™¤: auto-stage-1730123456789

âœ… æ¸…ç†å®Œæˆ
```

### é æœŸçµæœ

#### âœ… æˆåŠŸçš„æ¸¬è©¦

```
============================================================
æ¸¬è©¦å®Œæˆ
============================================================

ğŸ‰ æ‰€æœ‰æ¸¬è©¦æ­¥é©Ÿå·²å®Œæˆï¼

ğŸ’¡ ä¸‹ä¸€æ­¥ï¼š
1. åœ¨ AWS æ§åˆ¶å°é©—è­‰çµæœ
2. ç¢ºèª Participant Replication æ˜¯å¦æ­£å¸¸å·¥ä½œ
3. æª¢æŸ¥å…©å€‹ Stage æ˜¯å¦éƒ½èƒ½çœ‹åˆ°ä¸»æ’­
```

**AWS æ§åˆ¶å°æ‡‰è©²é¡¯ç¤ºï¼š**
- Master Stageï¼š1 å€‹ Publisherï¼ˆä¸»æ’­ï¼‰
- è‡ªå‹•æ“´å±• Stageï¼š1 å€‹ Publisherï¼ˆè¤‡è£½çš„ä¸»æ’­ï¼‰

#### âŒ å¸¸è¦‹å•é¡Œ

**å•é¡Œ 1ï¼šè‡ªå‹•æ“´å±•æ²’æœ‰è§¸ç™¼**

```
â³ æª¢æŸ¥ 10/10 - æ‰¾åˆ° 1 å€‹ Stage (0 å€‹è‡ªå‹•æ“´å±•)

âš ï¸ ç­‰å¾…è¶…æ™‚ï¼Œæœªæª¢æ¸¬åˆ°è‡ªå‹•æ“´å±•

å¯èƒ½åŸå› ï¼š
1. è§€çœ¾æ•¸æœªé”åˆ°é–¾å€¼ï¼ˆ45ï¼‰
2. è‡ªå‹•æ“´å±•æœå‹™æœªå•Ÿå‹•
3. é”åˆ° Stage æ•¸é‡ä¸Šé™
```

è§£æ±ºæ–¹æ¡ˆï¼š
- æª¢æŸ¥ API æ—¥èªŒæ˜¯å¦æœ‰è‡ªå‹•æ“´å±•ç›¸é—œéŒ¯èª¤
- ç¢ºèªè§€çœ¾æ•¸æ˜¯å¦æ­£ç¢ºå¢åŠ 
- æª¢æŸ¥ `StageAutoScalingService` æ˜¯å¦å·²å•Ÿå‹•

**å•é¡Œ 2ï¼šReplication æœªå•Ÿå‹•**

```
âŒ auto-stage-xyz - æ²’æœ‰ Replication

ç¸½çµï¼š0/1 å€‹ Stage å•Ÿå‹•äº† Replication
```

è§£æ±ºæ–¹æ¡ˆï¼š
- ç¢ºèªä¸»æ’­æ­£åœ¨æ¨æµï¼ˆæª¢æŸ¥ OBS ç‹€æ…‹ï¼‰
- æŸ¥çœ‹ API æ—¥èªŒä¸­çš„ Replication éŒ¯èª¤
- ä½¿ç”¨ `check-stage-participants.js` é©—è­‰ä¸»æ’­ç‹€æ…‹
- æª¢æŸ¥ AWS SDK ç‰ˆæœ¬ï¼ˆéœ€è¦ >= 3.600.0ï¼‰

**å•é¡Œ 3ï¼šAWS æ§åˆ¶å°é¡¯ç¤º "no publishers"**

åŸå› ï¼š
- ä¸»æ’­æ²’æœ‰çœŸæ­£é–‹å§‹æ¨æµ
- åªç”Ÿæˆäº† Token ä½†æ²’æœ‰é€£æ¥åˆ° Stage

è§£æ±ºæ–¹æ¡ˆï¼š
1. ç¢ºèª OBS é¡¯ç¤ºã€Œä¸²æµä¸­ã€
2. ä½¿ç”¨ `check-stage-participants.js` æª¢æŸ¥ï¼š
   ```bash
   node check-stage-participants.js <stage-arn>
   ```

---

## ğŸ” verify-replication.js - API å±¤é¢è¨ºæ–·

### ç”¨é€”

å¿«é€Ÿæª¢æŸ¥ Replication é…ç½®ç‹€æ…‹ï¼ˆä¸éœ€è¦æ¨æµï¼‰ã€‚

### ä½¿ç”¨æ–¹å¼

```bash
node verify-replication.js
```

### è¼¸å‡ºç¤ºä¾‹

```
æ­¥é©Ÿ 1ï¼šæª¢æŸ¥ä¸»æ’­ç‹€æ…‹
âœ… æ‰¾åˆ°ä¸»æ’­è³‡è¨Š
  - Participant ID: abc123
  - User ID: test-broadcaster
  ...

æ­¥é©Ÿ 2ï¼šåˆ—å‡ºæ‰€æœ‰ Stage
âœ… æ‰¾åˆ° 2 å€‹ Stage

æ­¥é©Ÿ 3ï¼šæª¢æŸ¥ Replication ç‹€æ…‹
  âœ… auto-stage-xyz - æœ‰ Replication

æ­¥é©Ÿ 4ï¼šè¨ºæ–·å»ºè­°
âœ… æœ‰ 1 å€‹ Stage å•Ÿå‹•äº† Replication
```

---

## ğŸ”¬ check-stage-participants.js - AWS ç›´æ¥æŸ¥è©¢

### ç”¨é€”

ç›´æ¥ä½¿ç”¨ AWS SDK æŸ¥è©¢ Stage çš„å¯¦éš›åƒèˆ‡è€…ï¼ˆæœ€æº–ç¢ºï¼‰ã€‚

### ä½¿ç”¨æ–¹å¼

```bash
# éœ€è¦æä¾› Stage ARN
node check-stage-participants.js <stage-arn-1> [stage-arn-2] ...
```

### ç¤ºä¾‹

```bash
node check-stage-participants.js \
  arn:aws:ivs:us-east-1:123456789012:stage/abc123 \
  arn:aws:ivs:us-east-1:123456789012:stage/xyz789
```

### è¼¸å‡ºç¤ºä¾‹

```
æª¢æŸ¥ Stage 1/2
ARN: arn:aws:ivs:...

ğŸ“‹ Stage: Stage 1
   åƒèˆ‡è€…æ•¸é‡: 1

   1. Participant ID: abc123xyz
      User ID: test-broadcaster
      ç‹€æ…‹: CONNECTED
      ç™¼å¸ƒ: æ˜¯  âœ…

ğŸ“Š çµ±è¨ˆï¼š
   ç¸½åƒèˆ‡è€…: 1
   ç™¼å¸ƒè€…ï¼ˆä¸»æ’­ï¼‰: 1
   è¨‚é–±è€…ï¼ˆè§€çœ¾ï¼‰: 0

è¨ºæ–·å»ºè­°
âœ… æœ‰ 1 å€‹ Stage æœ‰ä¸»æ’­åœ¨æ¨æµ
```

---

## ğŸ“ æ¸¬è©¦æœ€ä½³å¯¦è¸

### 1. æ¸¬è©¦å‰æº–å‚™

- âœ… ç¢ºä¿ API æœå‹™å™¨é‹è¡Œ
- âœ… ç¢ºä¿ Redis é‹è¡Œ
- âœ… AWS æ†‘è­‰å·²é…ç½®
- âœ… OBS Studio å·²å®‰è£

### 2. æ¸¬è©¦é †åº

1. å…ˆä½¿ç”¨ `test-full-flow.js` é€²è¡Œå®Œæ•´æ¸¬è©¦
2. å¦‚æœé‡åˆ°å•é¡Œï¼Œä½¿ç”¨ `verify-replication.js` è¨ºæ–·é…ç½®
3. ä½¿ç”¨ `check-stage-participants.js` æŸ¥çœ‹å¯¦éš›ç‹€æ…‹

### 3. é©—è­‰ Replication æ˜¯å¦æˆåŠŸ

**æ–¹æ³• 1ï¼šAWS æ§åˆ¶å°ï¼ˆæ¨è–¦ï¼‰**
- æŸ¥çœ‹å…©å€‹ Stage çš„ Participants
- éƒ½æ‡‰è©²é¡¯ç¤º Publisher

**æ–¹æ³• 2ï¼šä½¿ç”¨è¨ºæ–·å·¥å…·**
```bash
node check-stage-participants.js <master-stage-arn> <replica-stage-arn>
```

**æ–¹æ³• 3ï¼šæŸ¥çœ‹ API æ—¥èªŒ**
```bash
# æœç´¢ Replication ç›¸é—œæ—¥èªŒ
grep "Participant Replication" logs/app.log
```

### 4. æ¸…ç†æ¸¬è©¦è³‡æº

æ¸¬è©¦å¾Œè¨˜å¾—æ¸…ç†ï¼š
- åœ¨æ¸¬è©¦å·¥å…·ä¸­é¸æ“‡æ¸…ç†
- æˆ–æ‰‹å‹•åˆªé™¤æ¸¬è©¦ Stage
- åœæ­¢ OBS æ¨æµ

---

## ğŸ› æ•…éšœæ’é™¤

### å•é¡Œï¼šè‡ªå‹•æ“´å±•æ²’æœ‰è§¸ç™¼

**æª¢æŸ¥æ¸…å–®ï¼š**
- [ ] è§€çœ¾æ•¸æ˜¯å¦ â‰¥ 45ï¼Ÿ
- [ ] `StageAutoScalingService` æ˜¯å¦å•Ÿå‹•ï¼Ÿ
- [ ] æ˜¯å¦é”åˆ° Stage ä¸Šé™ï¼ˆ10ï¼‰ï¼Ÿ
- [ ] æª¢æŸ¥ API æ—¥èªŒ

### å•é¡Œï¼šReplication å¤±æ•—

**æª¢æŸ¥æ¸…å–®ï¼š**
- [ ] ä¸»æ’­æ˜¯å¦åœ¨æ¨æµï¼Ÿï¼ˆOBS é¡¯ç¤ºã€Œä¸²æµä¸­ã€ï¼‰
- [ ] AWS SDK ç‰ˆæœ¬æ˜¯å¦ >= 3.600.0ï¼Ÿ
- [ ] æŸ¥çœ‹ API æ—¥èªŒä¸­çš„éŒ¯èª¤è¨Šæ¯
- [ ] ä½¿ç”¨ `check-stage-participants.js` é©—è­‰

### å•é¡Œï¼šAWS æ§åˆ¶å°é¡¯ç¤º "no publishers"

**åŸå› ï¼š**
- ä¸»æ’­æ²’æœ‰çœŸæ­£æ¨æµ

**è§£æ±ºï¼š**
1. ç¢ºèª OBS ç‹€æ…‹
2. ä½¿ç”¨ `check-stage-participants.js` é©—è­‰
3. æª¢æŸ¥ Token æ˜¯å¦æ­£ç¢º

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [Participant Replication åŠŸèƒ½æ–‡æª”](./PARTICIPANT_REPLICATION.md)
- [Participant Replication ä½¿ç”¨æŒ‡å—](./PARTICIPANT_REPLICATION_USAGE.md)
- [API æ–‡æª”](./API.md)

---

## ğŸ¯ ç¸½çµ

| å ´æ™¯ | ä½¿ç”¨å·¥å…· |
|------|---------|
| å®Œæ•´æµç¨‹æ¸¬è©¦ | `test-full-flow.js` |
| å¿«é€Ÿè¨ºæ–·é…ç½® | `verify-replication.js` |
| é©—è­‰å¯¦éš›ç‹€æ…‹ | `check-stage-participants.js` |
| AWS æ§åˆ¶å°é©—è­‰ | é»æ“Šæ¸¬è©¦å·¥å…·æä¾›çš„éˆæ¥ |

è¨˜ä½ï¼š**Participant Replication è¦æ±‚ä¸»æ’­æ­£åœ¨æ¨æµï¼**
